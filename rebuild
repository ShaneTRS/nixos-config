#!/usr/bin/env nix
#!nix shell --command bash

[ -z "$SRC" ] && SRC="$HOME/.config/nixos"
[ -z "$SECRETS" ] && SECRETS="$SRC/secrets"
[ -z "$INTERACTIVE" ] && INTERACTIVE=true
[ -z "$COMMIT" ] && COMMIT=true
[ -z "$UPDATE" ] && UPDATE=false
[ -z "$MACHINE" ] && MACHINE="machine.toml"
# Should probably fallback to "su -c" instead
[ -z "$SUDO" ] && which doas &>/dev/null &&
  SUDO="doas" || SUDO="sudo"

cd "$SRC" || exit 1

if grep --quiet 'serial ?= ?""' "$MACHINE"; then
  echo Serial number is missing! Grabbing from system..
  SERIAL=$(doas cat /sys/devices/virtual/dmi/id/board_serial)
  sed -iE "s:serial ?= ?\"\":serial = \"$SERIAL\":g" "$MACHINE"
  HW_CONF="hardware/$SERIAL.nix"
  if ! [ -f "$HW_CONF" ]; then
    printf "# %s (%s)\n{ }\n" \
      "$(cat /sys/devices/virtual/dmi/id/product_name)" \
      "$(cat /sys/devices/virtual/dmi/id/product_version)" > "$HW_CONF"
    echo "Hardware config is missing! The build will fail."
    exit 1
  fi
fi

build() { $SUDO nixos-rebuild "$@" --flake ".?submodules=1#system" --log-format internal-json 2>&1 | nom --json; }

track() {
  if [ "$1" == "add" ]; then
    git update-index --really-refresh "${@:2}"
  elif [ "$1" == "rm" ]; then
    git restore --staged "${@:2}"
    git update-index --assume-unchanged --skip-worktree "${@:2}"
  fi
}

update-repo() {(
  cd "$1" || exit 1
  git add -A; git update-index --refresh >/dev/null
  git diff-index --quiet HEAD -- ||
    git commit -am "AUTO: Configuration updated"
)}

# shellcheck disable=SC3010
if ! git diff-index --quiet HEAD -- &&
  $INTERACTIVE && ! git diff --color-words |
    awk '!/--- a|+++ b|index [0-9a-z]{6}/ {print $0}' | less -RK;
then 
  echo "Cancelled configuration update";
  exit 1
fi

$UPDATE && nix flake update
track add "$MACHINE"
BUILD=$(build "$@" && echo 1)
track rm "$MACHINE"

if $COMMIT && [ -n "$BUILD" ] && [ "$1" != "test" ]; then
  update-repo .
  update-repo secrets
fi

# Symlink the shared and user home directories
ln -sf "$SECRETS/home/." "$SRC/homes/secrets" 2>/dev/null
"$SRC/homes/symlink" shared "$(awk -F'"' '/user ?=/{print $2}' "$MACHINE")" secrets/.

exec true